<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Smart Form - 1-Click Excel Processing</title>
    <!-- 
        For standalone offline use, download xlsx.full.min.js from:
        https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js
        or https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js
        and place it in the same directory, then update the script src below
    -->
    <script>
        // Handle library loading error (defined before script tag)
        function handleLibraryError() {
            console.log('SheetJS failed to load from CDN');
        }
    </script>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js" onerror="handleLibraryError()"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container { max-width: 1024px; margin: 0 auto; }
        .card { 
            background: white; 
            border-radius: 1rem; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
            padding: 2rem; 
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
        .header { text-align: center; margin-bottom: 3rem; }
        .header h1 { font-size: 3rem; font-weight: bold; color: #1f2937; margin-bottom: 0.5rem; }
        .header p { font-size: 1.25rem; color: #6b7280; }
        .step-header { display: flex; align-items: center; margin-bottom: 1rem; }
        .step-number { 
            width: 2.5rem; height: 2.5rem; 
            background: #3b82f6; color: white; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; margin-right: 0.75rem;
        }
        .step-number.green { background: #10b981; }
        .step-number.purple { background: #8b5cf6; }
        .step-title { font-size: 1.5rem; font-weight: bold; color: #1f2937; }
        .step-desc { color: #6b7280; margin-bottom: 1.5rem; }
        .drop-zone { 
            border: 4px dashed #d1d5db; 
            border-radius: 1rem; 
            padding: 3rem; 
            text-align: center; 
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .drop-zone:hover { background: #f9fafb; border-color: #9ca3af; }
        .drop-zone.drag-over { background: #e0f2fe; border-color: #0284c7; transform: scale(1.02); }
        .drop-zone svg { width: 4rem; height: 4rem; color: #9ca3af; margin: 0 auto 1rem; }
        .drop-zone p { font-size: 1.125rem; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
        .drop-zone .small { font-size: 0.875rem; color: #6b7280; }
        .file-info { 
            margin-top: 1rem; 
            background: #eff6ff; 
            border: 1px solid #bfdbfe; 
            border-radius: 0.5rem; 
            padding: 1rem;
        }
        .file-info p { font-size: 0.875rem; font-weight: 600; color: #1e40af; margin-bottom: 0.25rem; }
        .file-info .filename { font-size: 1.125rem; color: #1e3a8a; }
        .hidden { display: none !important; }
        .btn { 
            width: 100%; 
            padding: 1rem 1.5rem; 
            font-weight: bold; 
            border-radius: 1rem; 
            border: none; 
            cursor: pointer; 
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-top: 1.5rem; }
        .btn-primary:hover { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .btn-download { background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; }
        .btn-download:hover { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .btn-reset { background: #6b7280; color: white; }
        .btn-reset:hover { background: #4b5563; }
        .btn svg { width: 1.5rem; height: 1.5rem; margin-right: 0.5rem; }
        .sheet-item { 
            background: #f9fafb; 
            border: 2px solid #e5e7eb; 
            border-radius: 0.75rem; 
            padding: 1rem; 
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .sheet-item:hover { background: #eff6ff; border-color: #93c5fd; }
        .sheet-item.active { background: #eff6ff; border-color: #3b82f6; }
        .sheet-item-content { display: flex; justify-content: space-between; align-items: center; }
        .sheet-item h3 { font-weight: bold; font-size: 1.125rem; color: #1f2937; margin-bottom: 0.25rem; }
        .sheet-item p { font-size: 0.875rem; color: #6b7280; }
        .sheet-badge { 
            width: 2rem; height: 2rem; 
            background: #3b82f6; color: white; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            font-size: 0.875rem;
        }
        .form-row { 
            background: #f9fafb; 
            border: 2px solid #e5e7eb; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            margin-bottom: 1rem;
        }
        .form-row h3 { font-weight: bold; font-size: 1.125rem; color: #1f2937; margin-bottom: 1rem; }
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
        @media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        .form-field label { 
            display: block; 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 0.5rem;
        }
        .form-field label .type { color: #9ca3af; font-size: 0.75rem; }
        .form-field input[type="text"],
        .form-field input[type="number"],
        .form-field input[type="email"],
        .form-field input[type="date"] { 
            width: 100%; 
            padding: 0.75rem 1rem; 
            border: 2px solid #d1d5db; 
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-field input:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-field input[type="checkbox"] { 
            width: 1.5rem; 
            height: 1.5rem; 
            border: 2px solid #d1d5db;
            cursor: pointer;
        }
        .delete-row { 
            margin-top: 1rem; 
            color: #ef4444; 
            font-weight: 600; 
            cursor: pointer; 
            background: none; 
            border: none;
            padding: 0.5rem;
        }
        .delete-row:hover { color: #dc2626; text-decoration: underline; }
        .btn-group { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .btn-group .btn { width: auto; flex: 1; }
        .btn-add { 
            background: #3b82f6; 
            color: white; 
            padding: 0.75rem 1.5rem;
            margin-top: 1rem;
        }
        .btn-add:hover { background: #2563eb; }
        .console { 
            background: #1f2937; 
            border-radius: 1rem; 
            padding: 1.5rem; 
            margin-top: 2rem;
        }
        .console-header { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .console-dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; margin-right: 0.5rem; }
        .console-dot.red { background: #ef4444; }
        .console-dot.yellow { background: #eab308; }
        .console-dot.green { background: #10b981; }
        .console-title { color: #9ca3af; font-size: 0.875rem; margin-left: 0.5rem; }
        .console-log { 
            background: #000; 
            border-radius: 0.5rem; 
            padding: 1rem; 
            height: 12rem; 
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        .console-log div { color: #10b981; margin-bottom: 0.25rem; }
        .console-log .warn { color: #eab308; }
        .console-log .error { color: #ef4444; }
        .console-log .success { color: #60a5fa; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-animate { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header fade-in">
            <h1>üìä Excel Smart Form</h1>
            <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É, —Å–∫–∞—á–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî –≤—Å—ë –≤ –±—Ä–∞—É–∑–µ—Ä–µ!</p>
        </header>

        <!-- Step 1: File Upload -->
        <div id="step1" class="card fade-in">
            <div class="step-header">
                <div class="step-number">1</div>
                <h2 class="step-title">–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª</h2>
            </div>
            <p class="step-desc">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ –≤ –æ–±–ª–∞—Å—Ç—å –Ω–∏–∂–µ</p>
            
            <div id="dropZone" class="drop-zone">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Å—é–¥–∞</p>
                <p class="small">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .xls</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            </div>
            
            <div id="fileInfo" class="file-info hidden">
                <p>–ó–∞–≥—Ä—É–∂–µ–Ω —Ñ–∞–π–ª:</p>
                <p id="fileName" class="filename"></p>
            </div>
        </div>

        <!-- Step 2: Data Structure Analysis -->
        <div id="step2" class="card hidden">
            <div class="step-header">
                <div class="step-number green">2</div>
                <h2 class="step-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö</h2>
            </div>
            <p class="step-desc">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ª–∏—Å—Ç—ã –∏ —Å—Ç–æ–ª–±—Ü—ã</p>
            
            <div id="sheetsContainer"></div>
            
            <button id="analyzeBtn" class="btn btn-primary">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
                –°–æ–∑–¥–∞—Ç—å —Ñ–æ—Ä–º—É
            </button>
        </div>

        <!-- Step 3: Dynamic Form -->
        <div id="step3" class="card hidden">
            <div class="step-header">
                <div class="step-number purple">3</div>
                <h2 class="step-title">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
            </div>
            <p class="step-desc">–í–≤–µ–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ</p>
            
            <div id="formContainer"></div>
            
            <div class="btn-group">
                <button id="downloadBtn" class="btn btn-download">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    –°–∫–∞—á–∞—Ç—å Excel
                </button>
                <button id="resetBtn" class="btn btn-reset">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                </button>
            </div>
        </div>

        <!-- Console Log -->
        <div class="console">
            <div class="console-header">
                <div class="console-dot red"></div>
                <div class="console-dot yellow"></div>
                <div class="console-dot green"></div>
                <span class="console-title">Console Log</span>
            </div>
            <div id="log" class="console-log"></div>
        </div>
    </div>

    <script>
        // Global variables
        let workbook = null;
        let currentSheetName = null;
        let dataStructure = null;
        let formData = [];
        let libraryLoaded = false;

        // Check if XLSX library is loaded
        window.addEventListener('load', function() {
            if (typeof XLSX !== 'undefined') {
                libraryLoaded = true;
                log('‚úÖ SheetJS –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            } else {
                showLibraryWarning();
            }
        });

        // Show library warning in UI
        function showLibraryWarning() {
            if (typeof XLSX === 'undefined') {
                log('‚ö†Ô∏è SheetJS –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ xlsx.full.min.js –ª–æ–∫–∞–ª—å–Ω–æ.', 'warn');
                log('üì• –°–∫–∞—á–∞–π—Ç–µ —Å: https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js', 'warn');
                const dropZone = document.getElementById('dropZone');
                if (dropZone) {
                    const notice = document.createElement('div');
                    notice.style.cssText = 'background: #fef3c7; border: 2px solid #f59e0b; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;';
                    notice.innerHTML = '<p style="color: #92400e; font-weight: bold; margin-bottom: 0.5rem;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ SheetJS</p>' +
                        '<p style="color: #78350f; font-size: 0.875rem;">–î–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel —Ñ–∞–π–ª–∞–º–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É SheetJS.<br>' +
                        '–°–∫–∞—á–∞–π—Ç–µ <code>xlsx.full.min.js</code> —Å <a href="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js" style="color: #1e40af; text-decoration: underline;">CDN</a> ' +
                        '–∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ index.html</p>';
                    dropZone.parentNode.insertBefore(notice, dropZone.nextSibling);
                }
            }
        }

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const cssClass = {
                'info': '',
                'warn': 'warn',
                'error': 'error',
                'success': 'success'
            }[type] || '';
            logDiv.innerHTML += `<div class="${cssClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Detect data type from value
        function detectType(value) {
            if (value === null || value === undefined || value === '') return 'text';
            
            // Check if it's a number
            if (typeof value === 'number' || !isNaN(parseFloat(value))) {
                return 'number';
            }
            
            // Check if it's a date
            const dateValue = new Date(value);
            if (dateValue instanceof Date && !isNaN(dateValue) && typeof value === 'string' && value.match(/\d{1,4}[-/.]\d{1,2}[-/.]\d{1,4}/)) {
                return 'date';
            }
            
            // Check if it's a boolean
            if (typeof value === 'boolean' || value === 'true' || value === 'false' || value === '–¥–∞' || value === '–Ω–µ—Ç') {
                return 'checkbox';
            }
            
            // Check if it's an email
            if (typeof value === 'string' && value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
                return 'email';
            }
            
            return 'text';
        }

        // Analyze data structure
        function analyzeStructure(sheet) {
            log('–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            const range = XLSX.utils.decode_range(sheet['!ref']);
            const columns = [];
            
            // Get first row (headers)
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: range.s.r, c: col });
                const cell = sheet[cellAddress];
                const headerName = cell ? cell.v : `Column ${col + 1}`;
                
                // Sample data from next rows to detect type
                let detectedType = 'text';
                const samples = [];
                
                for (let row = range.s.r + 1; row <= Math.min(range.s.r + 10, range.e.r); row++) {
                    const dataCellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const dataCell = sheet[dataCellAddress];
                    if (dataCell && dataCell.v !== null && dataCell.v !== undefined && dataCell.v !== '') {
                        samples.push(dataCell.v);
                    }
                }
                
                // Detect type from samples
                if (samples.length > 0) {
                    const types = samples.map(detectType);
                    // Most common type
                    const typeCounts = {};
                    types.forEach(t => typeCounts[t] = (typeCounts[t] || 0) + 1);
                    detectedType = Object.keys(typeCounts).reduce((a, b) => typeCounts[a] > typeCounts[b] ? a : b);
                }
                
                columns.push({
                    name: headerName,
                    type: detectedType,
                    col: col
                });
            }
            
            log(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${columns.length} —Å—Ç–æ–ª–±—Ü–æ–≤`, 'success');
            return { columns };
        }

        // Parse Excel file
        function parseExcel(file) {
            if (typeof XLSX === 'undefined') {
                log('‚ùå –û—à–∏–±–∫–∞: SheetJS –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error');
                alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ SheetJS –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ xlsx.full.min.js –ª–æ–∫–∞–ª—å–Ω–æ.');
                return;
            }
            
            log(`–ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞: ${file.name}`, 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbook = XLSX.read(data, { type: 'array' });
                    
                    log(`–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω. –ù–∞–π–¥–µ–Ω–æ –ª–∏—Å—Ç–æ–≤: ${workbook.SheetNames.length}`, 'success');
                    
                    // Show file info
                    document.getElementById('fileInfo').classList.remove('hidden');
                    document.getElementById('fileName').textContent = file.name;
                    
                    // Show step 2
                    setTimeout(() => {
                        document.getElementById('step2').classList.remove('hidden');
                        document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        displaySheets();
                    }, 300);
                    
                } catch (error) {
                    log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Display sheets
        function displaySheets() {
            const container = document.getElementById('sheetsContainer');
            container.innerHTML = '';
            
            workbook.SheetNames.forEach((sheetName, index) => {
                const sheet = workbook.Sheets[sheetName];
                const range = sheet['!ref'] ? XLSX.utils.decode_range(sheet['!ref']) : null;
                const rowCount = range ? range.e.r - range.s.r + 1 : 0;
                const colCount = range ? range.e.c - range.s.c + 1 : 0;
                
                const sheetDiv = document.createElement('div');
                sheetDiv.className = 'sheet-item' + (index === 0 ? ' active' : '');
                if (index === 0) {
                    currentSheetName = sheetName;
                }
                
                sheetDiv.innerHTML = `
                    <div class="sheet-item-content">
                        <div>
                            <h3>${sheetName}</h3>
                            <p>${rowCount} —Å—Ç—Ä–æ–∫ √ó ${colCount} —Å—Ç–æ–ª–±—Ü–æ–≤</p>
                        </div>
                        <div class="sheet-badge">${index === 0 ? '‚úì' : (index + 1)}</div>
                    </div>
                `;
                
                sheetDiv.addEventListener('click', () => {
                    document.querySelectorAll('.sheet-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    sheetDiv.classList.add('active');
                    currentSheetName = sheetName;
                    log(`–í—ã–±—Ä–∞–Ω –ª–∏—Å—Ç: ${sheetName}`, 'info');
                });
                
                container.appendChild(sheetDiv);
            });
        }

        // Create dynamic form
        function createForm() {
            if (!currentSheetName) {
                log('–õ–∏—Å—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
                return;
            }
            
            log(`–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–ª—è –ª–∏—Å—Ç–∞: ${currentSheetName}`, 'info');
            
            const sheet = workbook.Sheets[currentSheetName];
            dataStructure = analyzeStructure(sheet);
            
            // Extract data
            const range = XLSX.utils.decode_range(sheet['!ref']);
            formData = [];
            
            // Get data rows (skip header)
            for (let row = range.s.r + 1; row <= range.e.r; row++) {
                const rowData = {};
                dataStructure.columns.forEach(col => {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col.col });
                    const cell = sheet[cellAddress];
                    rowData[col.name] = cell ? cell.v : '';
                });
                formData.push(rowData);
            }
            
            log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${formData.length} —Å—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö`, 'success');
            
            // Show step 3
            document.getElementById('step3').classList.remove('hidden');
            document.getElementById('step3').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            renderForm();
        }

        // Render form
        function renderForm() {
            const container = document.getElementById('formContainer');
            container.innerHTML = '';
            
            if (formData.length === 0) {
                formData.push({});
                dataStructure.columns.forEach(col => {
                    formData[0][col.name] = '';
                });
            }
            
            formData.forEach((rowData, rowIndex) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'form-row';
                
                let rowHTML = `<h3>–ó–∞–ø–∏—Å—å ${rowIndex + 1}</h3><div class="form-grid">`;
                
                dataStructure.columns.forEach(col => {
                    const value = rowData[col.name] || '';
                    const inputId = `input_${rowIndex}_${col.name.replace(/\s/g, '_')}`;
                    
                    let inputHTML = '';
                    switch (col.type) {
                        case 'number':
                            inputHTML = `<input type="number" id="${inputId}" value="${value}" data-row="${rowIndex}" data-col="${col.name}">`;
                            break;
                        case 'date':
                            const dateValue = value ? new Date(value).toISOString().split('T')[0] : '';
                            inputHTML = `<input type="date" id="${inputId}" value="${dateValue}" data-row="${rowIndex}" data-col="${col.name}">`;
                            break;
                        case 'checkbox':
                            const checked = value === true || value === 'true' || value === '–¥–∞' ? 'checked' : '';
                            inputHTML = `<input type="checkbox" id="${inputId}" ${checked} data-row="${rowIndex}" data-col="${col.name}">`;
                            break;
                        case 'email':
                            inputHTML = `<input type="email" id="${inputId}" value="${value}" data-row="${rowIndex}" data-col="${col.name}">`;
                            break;
                        default:
                            inputHTML = `<input type="text" id="${inputId}" value="${value}" data-row="${rowIndex}" data-col="${col.name}">`;
                    }
                    
                    rowHTML += `
                        <div class="form-field">
                            <label for="${inputId}">
                                ${col.name} <span class="type">(${col.type})</span>
                            </label>
                            ${inputHTML}
                        </div>
                    `;
                });
                
                rowHTML += '</div>';
                
                // Add delete button for multiple rows
                if (formData.length > 1) {
                    rowHTML += `<button class="delete-row" onclick="deleteRow(${rowIndex})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
                }
                
                rowDiv.innerHTML = rowHTML;
                container.appendChild(rowDiv);
            });
            
            // Add new row button
            const addRowBtn = document.createElement('button');
            addRowBtn.className = 'btn btn-add';
            addRowBtn.innerHTML = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
            addRowBtn.onclick = addRow;
            container.appendChild(addRowBtn);
            
            // Add event listeners to inputs
            const inputs = container.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('change', updateFormData);
            });
        }

        // Update form data from inputs
        function updateFormData(event) {
            const input = event.target;
            const row = parseInt(input.dataset.row);
            const col = input.dataset.col;
            
            if (input.type === 'checkbox') {
                formData[row][col] = input.checked;
            } else {
                formData[row][col] = input.value;
            }
            
            log(`–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Å—Ç—Ä–æ–∫–∞ ${row + 1}, ${col} = ${formData[row][col]}`, 'info');
        }

        // Add new row
        function addRow() {
            const newRow = {};
            dataStructure.columns.forEach(col => {
                newRow[col.name] = '';
            });
            formData.push(newRow);
            renderForm();
            log('–î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å', 'success');
        }

        // Delete row
        function deleteRow(rowIndex) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ${rowIndex + 1}?`)) {
                formData.splice(rowIndex, 1);
                renderForm();
                log(`–£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å ${rowIndex + 1}`, 'warn');
            }
        }

        // Download Excel
        function downloadExcel() {
            log('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è...', 'info');
            
            try {
                // Create new workbook
                const wb = XLSX.utils.book_new();
                
                // Prepare data with headers
                const wsData = [];
                wsData.push(dataStructure.columns.map(col => col.name));
                
                formData.forEach(row => {
                    const rowArray = dataStructure.columns.map(col => row[col.name] || '');
                    wsData.push(rowArray);
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, currentSheetName || 'Sheet1');
                
                // Generate filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const filename = `excel_smart_form_${timestamp}.xlsx`;
                
                // Download
                XLSX.writeFile(wb, filename);
                
                log(`‚úÖ –§–∞–π–ª ${filename} —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω!`, 'success');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
            }
        }

        // Reset application
        function resetApp() {
            if (confirm('–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ? –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                workbook = null;
                currentSheetName = null;
                dataStructure = null;
                formData = [];
                
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('fileInput').value = '';
                
                log('üîÑ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ', 'warn');
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                parseExcel(file);
            }
        });
        
        // Drag and drop
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const file = e.dataTransfer.files[0];
            if (file) {
                parseExcel(file);
            }
        });
        
        // Button handlers
        document.getElementById('analyzeBtn').addEventListener('click', createForm);
        document.getElementById('downloadBtn').addEventListener('click', downloadExcel);
        document.getElementById('resetBtn').addEventListener('click', resetApp);
        
        // Initial log
        log('‚ú® Excel Smart Form –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!', 'success');
        log('–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'info');
    </script>
</body>
</html>
